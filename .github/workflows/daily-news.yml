name: 每日科技新闻

on:
  # 定时触发已迁移到 Cloudflare Workers，确保精确执行
  # 原 schedule: cron: '30 0 * * *' (每天 8:30 北京时间)
  # 现在通过 Cloudflare Workers Cron Triggers 调用 workflow_dispatch

  # 支持手动触发和外部调用
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    # 添加超时限制
    timeout-minutes: 15

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: 安装依赖
        run: |
          python3 -m pip install --upgrade pip
          pip install requests urllib3 zhdate

      - name: 生成并发布新闻
        env:
          WECHAT_API_KEY: ${{ secrets.WECHAT_API_KEY }}
          DOUBAO_API_KEY: ${{ secrets.DOUBAO_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          set -x  # 显示执行的命令
          cd scripts

          # 显示使用的 API
          if [ -n "$OPENROUTER_API_KEY" ]; then
            echo "使用 OpenRouter API (GPT-4o-mini)"
          elif [ -n "$DOUBAO_API_KEY" ]; then
            echo "使用豆包 API"
          else
            echo "错误：未设置 API Key"
            exit 1
          fi

          # 运行脚本，带重试机制
          MAX_RETRIES=3
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "尝试 $((RETRY_COUNT + 1))/$MAX_RETRIES..."

            if python3 auto_daily_news.py 2>&1; then
              echo "✅ 新闻发布成功！"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "⚠️ 失败，等待 30 秒后重试..."
                sleep 30
              fi
            fi
          done

          echo "::error::所有重试都失败了"
          exit 1

      - name: 记录日志
        if: always()
        run: |
          echo "任务执行时间: $(date)"
          echo "时区: Asia/Shanghai"
